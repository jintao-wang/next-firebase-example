import React, { useEffect } from 'react';
import PropTypes from 'prop-types';
import styled from 'styled-components';
import { UserInfo } from 'global.data';
import { loginStore } from 'store';
import {
  signIn,
  handleAuthStateChanged,
  handleSignOut,
} from 'firebase_server/auth';

import {
  handleGetOneDocInfo,
  handleAddDocInfo,
} from 'firebase_server/firebaseDb';

const Top = ({
  onLogin,
  onSignOut,
}) => {
  const [loginState, loginActions] = loginStore.useModel();

  useEffect(() => {
    handleLogin().then();
  }, []);

  const handleLogin = async () => {
    try {
      const user = await handleAuthStateChanged();
      if (user) {
        UserInfo.name = user.displayName;
        UserInfo.uid = user.uid;
        loginActions.onChange(true);
        onLogin?.();

        handleGetOneDocInfo('users', user.uid)
          .then((userDb) => {
            if (!userDb) {
              handleAddDocInfo('users', user.uid, {
                name: user.displayName,
                uid: user.uid,
                email: user.email,
              });
            }
          });
      } else {
        UserInfo.name = null;
        UserInfo.uid = null;
        loginActions.onChange(false);
        onSignOut?.();
      }
    } catch (e) {
      console.log(e);
    }
  };

  return (
    <ContainerSC>
      <LogoSC>
        <svg
          width="100"
          height="100"
          viewBox="0 0 172 172"
        >
          <g fill="none" fillRule="nonzero" stroke="none" strokeWidth="1" strokeLinecap="butt" strokeLinejoin="miter" strokeMiterlimit="10" strokeDasharray="" strokeDashoffset="0" fontFamily="none" fontWeight="none" fontSize="none" textAnchor="none">
            <path d="M0,172v-172h172v172z" fill="none" />
            <g>
              <path d="M135.02,82.56c-7.12447,0 -12.9,5.77553 -12.9,12.9c0,7.12447 5.77553,12.9 12.9,12.9c7.12447,0 12.9,-5.77553 12.9,-12.9c0,-7.12447 -5.77553,-12.9 -12.9,-12.9zM104.06,24.08c-7.12447,0 -12.9,5.77553 -12.9,12.9c0,7.12447 5.77553,12.9 12.9,12.9c7.12447,0 12.9,-5.77553 12.9,-12.9c0,-7.12447 -5.77553,-12.9 -12.9,-12.9zM39.56,25.8c-7.59944,0 -13.76,6.16056 -13.76,13.76c0,7.59944 6.16056,13.76 13.76,13.76c7.59944,0 13.76,-6.16056 13.76,-13.76c0,-7.59944 -6.16056,-13.76 -13.76,-13.76zM38.7,108.36c-8.0744,0 -14.62,6.5456 -14.62,14.62c0,8.0744 6.5456,14.62 14.62,14.62c8.0744,0 14.62,-6.5456 14.62,-14.62c0,-8.0744 -6.5456,-14.62 -14.62,-14.62zM113.52,122.12c-7.59944,0 -13.76,6.16056 -13.76,13.76c0,7.59944 6.16056,13.76 13.76,13.76c7.59944,0 13.76,-6.16056 13.76,-13.76c0,-7.59944 -6.16056,-13.76 -13.76,-13.76z" fill="#3370ff" />
              <path d="M111.8,87.72c0,13.30592 -10.77408,24.08 -24.08,24.08c-13.30076,0 -24.08,-10.77408 -24.08,-24.08c0,-13.29216 10.77924,-24.08 24.08,-24.08c13.30592,0 24.08,10.78784 24.08,24.08z" fill="#3370ff" />
              <path d="M69.84232,91.16c-0.4214,0 -0.78776,-0.3096 -0.8514,-0.73788c-0.12556,-0.88752 -0.19092,-1.7974 -0.19092,-2.70212c0,-10.4318 8.4882,-18.92 18.92,-18.92c0.301,0 0.602,0.00688 0.89956,0.02236c0.47472,0.02236 0.84108,0.42484 0.81872,0.89784c-0.02236,0.473 -0.45236,0.86688 -0.89956,0.81872c-0.27004,-0.01204 -0.54352,-0.01892 -0.81872,-0.01892c-9.48408,0 -17.2,7.71592 -17.2,17.2c0,0.82388 0.05848,1.6512 0.17544,2.45788c0.06708,0.46956 -0.25972,0.90644 -0.72928,0.97352c-0.043,0.00516 -0.08428,0.0086 -0.12384,0.0086zM87.72,106.64c-5.8308,0 -11.24708,-2.62644 -14.86252,-7.2068c-0.29412,-0.37324 -0.23048,-0.91332 0.14276,-1.20744c0.37152,-0.2924 0.91504,-0.22876 1.20744,0.14276c3.28692,4.1624 8.21128,6.55148 13.51232,6.55148c7.28076,0 13.79956,-4.60788 16.22304,-11.46724c0.15824,-0.4472 0.65016,-0.68284 1.09736,-0.5246c0.4472,0.15824 0.68284,0.65016 0.5246,1.09908c-2.666,7.54392 -9.83668,12.61276 -17.845,12.61276zM105.5994,91.16c-0.03956,0 -0.08084,-0.00344 -0.12212,-0.0086c-0.46956,-0.06708 -0.79808,-0.50224 -0.731,-0.9718c0.11524,-0.81012 0.17372,-1.63572 0.17372,-2.4596c0,-0.2752 -0.00688,-0.54696 -0.01892,-0.82044c-0.02236,-0.473 0.344,-0.8772 0.81872,-0.89784c0.48504,-0.04472 0.8772,0.344 0.89956,0.81872c0.01376,0.29756 0.02064,0.59684 0.02064,0.89956c0,0.903 -0.06364,1.81288 -0.19092,2.7004c-0.0602,0.43 -0.42828,0.7396 -0.84968,0.7396zM105.264,84.28c-0.387,0 -0.73788,-0.26144 -0.8342,-0.65532c-0.1376,-0.55556 -0.301,-1.10424 -0.4902,-1.63744c-0.15824,-0.44892 0.0774,-0.94084 0.5246,-1.09908c0.45064,-0.15824 0.93912,0.0774 1.09736,0.5246c0.20812,0.58824 0.387,1.18852 0.53664,1.80256c0.11352,0.46096 -0.16856,0.92708 -0.62952,1.03888c-0.06708,0.0172 -0.13588,0.0258 -0.20468,0.0258z" fill="#34495e" />
              <path d="M87.72,113.52c-14.22612,0 -25.8,-11.57388 -25.8,-25.8c0,-14.22612 11.57388,-25.8 25.8,-25.8c14.22612,0 25.8,11.57388 25.8,25.8c0,14.22612 -11.57388,25.8 -25.8,25.8zM87.72,65.36c-12.32896,0 -22.36,10.03104 -22.36,22.36c0,12.32896 10.03104,22.36 22.36,22.36c12.32896,0 22.36,-10.03104 22.36,-22.36c0,-12.32896 -10.03104,-22.36 -22.36,-22.36zM135.02,110.08c-8.06164,0 -14.62,-6.55836 -14.62,-14.62c0,-8.06164 6.55836,-14.62 14.62,-14.62c8.06164,0 14.62,6.55836 14.62,14.62c0,8.06164 -6.55836,14.62 -14.62,14.62zM135.02,84.28c-6.16448,0 -11.18,5.01552 -11.18,11.18c0,6.16448 5.01552,11.18 11.18,11.18c6.16448,0 11.18,-5.01552 11.18,-11.18c0,-6.16448 -5.01552,-11.18 -11.18,-11.18zM104.06,51.6c-8.06164,0 -14.62,-6.55836 -14.62,-14.62c0,-8.06164 6.55836,-14.62 14.62,-14.62c8.06164,0 14.62,6.55836 14.62,14.62c0,8.06164 -6.55836,14.62 -14.62,14.62zM104.06,25.8c-6.16448,0 -11.18,5.01552 -11.18,11.18c0,6.16448 5.01552,11.18 11.18,11.18c6.16448,0 11.18,-5.01552 11.18,-11.18c0,-6.16448 -5.01552,-11.18 -11.18,-11.18zM39.56,55.04c-8.53464,0 -15.48,-6.94364 -15.48,-15.48c0,-8.53636 6.94536,-15.48 15.48,-15.48c8.53464,0 15.48,6.94364 15.48,15.48c0,8.53636 -6.94536,15.48 -15.48,15.48zM39.56,27.52c-6.6392,0 -12.04,5.40252 -12.04,12.04c0,6.63748 5.4008,12.04 12.04,12.04c6.6392,0 12.04,-5.40252 12.04,-12.04c0,-6.63748 -5.4008,-12.04 -12.04,-12.04z" fill="#34495e" />
              <path d="M40.42,48.11356c-0.43344,0 -0.80496,-0.32508 -0.85484,-0.7654c-0.0516,-0.47128 0.28896,-0.89612 0.76024,-0.94944c1.30548,-0.14448 2.53528,-0.65876 3.55868,-1.48608c0.36808,-0.301 0.9116,-0.2408 1.20916,0.12728c0.29928,0.3698 0.24252,0.90988 -0.12728,1.20916c-1.27968,1.03716 -2.81908,1.68044 -4.45308,1.85932c-0.03096,0.00344 -0.06192,0.00516 -0.09288,0.00516zM46.85968,43c-0.0946,0 -0.19264,-0.01548 -0.28724,-0.04816c-0.4472,-0.15996 -0.68112,-0.65016 -0.52288,-1.09908c0.258,-0.73272 0.39044,-1.50328 0.39044,-2.29276c0,-3.79432 -3.08568,-6.88 -6.88,-6.88c-2.91024,0 -5.51776,1.84212 -6.48956,4.58724c-0.15824,0.4472 -0.64672,0.68112 -1.09736,0.5246c-0.44892,-0.15996 -0.68284,-0.65016 -0.5246,-1.09908c1.21432,-3.42796 4.47372,-5.73276 8.11152,-5.73276c4.74204,0 8.6,3.85796 8.6,8.6c0,0.98556 -0.16512,1.95048 -0.4902,2.86724c-0.12384,0.3526 -0.4558,0.57276 -0.81012,0.57276zM38.7,139.32c-9.00936,0 -16.34,-7.33064 -16.34,-16.34c0,-9.00936 7.33064,-16.34 16.34,-16.34c9.00936,0 16.34,7.33064 16.34,16.34c0,9.00936 -7.33064,16.34 -16.34,16.34zM38.7,110.08c-7.11392,0 -12.9,5.78608 -12.9,12.9c0,7.11392 5.78608,12.9 12.9,12.9c7.11392,0 12.9,-5.78608 12.9,-12.9c0,-7.11392 -5.78608,-12.9 -12.9,-12.9zM113.52,151.36c-8.53464,0 -15.48,-6.94364 -15.48,-15.48c0,-8.53636 6.94536,-15.48 15.48,-15.48c8.53464,0 15.48,6.94364 15.48,15.48c0,8.53636 -6.94536,15.48 -15.48,15.48zM113.52,123.84c-6.6392,0 -12.04,5.40252 -12.04,12.04c0,6.63748 5.4008,12.04 12.04,12.04c6.6392,0 12.04,-5.40252 12.04,-12.04c0,-6.63748 -5.4008,-12.04 -12.04,-12.04z" fill="#34495e" />
              <path d="M113.52,144.48c-4.74204,0 -8.6,-3.85796 -8.6,-8.6c0,-0.47472 0.38528,-0.86 0.86,-0.86c0.47472,0 0.86,0.38528 0.86,0.86c0,3.79432 3.08568,6.88 6.88,6.88c1.57036,0 3.1046,-0.5418 4.32408,-1.52908c0.3698,-0.29928 0.9116,-0.2408 1.20916,0.12728c0.29928,0.3698 0.24252,0.90988 -0.12728,1.20916c-1.52392,1.23324 -3.44344,1.91264 -5.40596,1.91264zM121.21356,137.6c-0.03096,0 -0.06364,-0.00172 -0.0946,-0.00516c-0.47128,-0.0516 -0.81356,-0.47644 -0.76024,-0.94944c0.02752,-0.25112 0.04128,-0.5074 0.04128,-0.7654c0,-0.78776 -0.13244,-1.55832 -0.39216,-2.29276c-0.15824,-0.44892 0.07568,-0.93912 0.52288,-1.09908c0.45236,-0.15996 0.93912,0.0774 1.09736,0.5246c0.3268,0.91848 0.49192,1.8834 0.49192,2.86724c0,0.32336 -0.0172,0.64156 -0.0516,0.9546c-0.04988,0.44032 -0.4214,0.7654 -0.85484,0.7654zM118.68,130.97112c-0.20468,0 -0.40936,-0.07224 -0.57276,-0.21844c-1.26248,-1.13176 -2.89304,-1.75268 -4.58724,-1.75268c-0.47472,0 -0.86,-0.38528 -0.86,-0.86c0,-0.47472 0.38528,-0.86 0.86,-0.86c2.11904,0 4.15552,0.77744 5.73276,2.18784c0.35432,0.3182 0.38356,0.86172 0.06708,1.21432c-0.16856,0.19092 -0.4042,0.28896 -0.63984,0.28896z" fill="#34495e" />
              <path d="M92.7007,63.99528l5.36629,-15.44461l3.24782,1.12847l-5.36629,15.44461z" fill="#34495e" />
              <path d="M112.97325,93.03886l0.55311,-3.39698l9.14011,1.48823l-0.55311,3.39698z" fill="#34495e" />
              <path d="M98.22241,110.8592l3.0686,-1.55477l7.00112,13.8179l-3.0686,1.55477z" fill="#34495e" />
              <path d="M48.66587,51.09127l2.43262,-2.43228l21.01366,21.0166l-2.43262,2.43228z" fill="#34495e" />
              <path d="M48.77637,113.92029l17.54535,-14.56074l2.19685,2.64716l-17.54535,14.56074z" fill="#34495e" />
            </g>
          </g>
        </svg>
        <span>MindCloud</span>
      </LogoSC>
      {
        loginState.isLogin ? (
          <LoginInfoSC
            onDoubleClick={() => {
              handleSignOut()
                .then((res) => {
                  UserInfo.name = null;
                  UserInfo.uid = null;
                  loginActions.onChange(false);
                })
                .catch((e) => {
                  console.error(e);
                });
            }}
          >
            {UserInfo.name[0].toUpperCase()}
          </LoginInfoSC>
        ) : (
          <LoginSC
            onClick={() => { signIn({}); }}
          >
            <div className="icon">
              <img
                alt=""
                src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg"
              />
            </div>
            <div>Sign in with Google</div>
          </LoginSC>
        )
      }
    </ContainerSC>
  );
};

export default Top;

Top.propTypes = {
  onLogin: PropTypes.func,
  onSignOut: PropTypes.func,
};
Top.defaultProps = {
  onLogin: null,
  onSignOut: null,
};

const ContainerSC = styled('header')`
  position: relative;
  width: 100%;
  height: 64px;
  padding: 0 24px;
  display: flex;
  align-items: center;
  box-sizing: border-box;
  justify-content: space-between;
`;

const LogoSC = styled('div')`
  display: flex;
  align-items: center;
  color: #1f2329;
  font-weight: 700;
  font-size: 14px;
  letter-spacing: 1px;
  
  svg {
    height: 36px;
    width: 36px;
    margin-right: 5px;
  }
`;

const LoginSC = styled('div')`
  height: 32px;
  padding: 0 20px;
  border-radius: 4px;
  display: flex;
  justify-content: center;
  align-items: center;
  color: #757575;
  font-size: 14px;
  cursor: pointer;
  font-weight: 00;
  background: rgba(255,255,255);
  box-shadow: 0 2px 2px 0 rgb(0 0 0 / 2%), 0 3px 1px -2px rgb(0 0 0 / 20%), 0 1px 5px 0 rgb(0 0 0 / 12%);
  
  .icon {
    height: 100%;
    margin-right: 5px;
    display: flex;
    align-items: center;
    
    img {
      margin-top: auto;
      margin-bottom: auto;
      height: 50%;
    }
  }
`;

const LoginInfoSC = styled('div')`
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: rgb(162, 94, 246);
  display: flex;
  justify-content: center;
  align-items: center;
  color: white;
  font-size: 14px;
  letter-spacing: 1px;
  cursor: pointer;
`;
